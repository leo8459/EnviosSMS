<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Enviar SMS</title>
<style>
 body{font-family:sans-serif;margin:40px;}
 table{border-collapse:collapse;width:100%;}
 th,td{border:1px solid #ccc;padding:6px;text-align:left;}
 th{background:#f0f0f0;}
 tr.ok   {background:#d4edda;}
 tr.fail {background:#f8d7da;}
 tr.wait {background:#fff4cc;}
 button{margin-top:15px;padding:8px 16px;}
</style>
</head>
<body>

<h2>ðŸ“¦ Paquetes disponibles (elige a quiÃ©n enviar SMS)</h2>

<table id="tabla">
 <thead><tr><th>#</th><th>CODIGO</th><th>TELÃ‰FONO</th><th>âœ”</th></tr></thead>
 <tbody></tbody>
</table>

<button id="btnEnviar">ðŸ“¤ Enviar SMS</button>

<script>
/* â”€â”€ 1. cargar paquetes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function cargarPaquetes(){
  const r   = await fetch('/api/paquetes');
  const arr = await r.json();
  const tbody = document.querySelector('#tabla tbody');
  tbody.innerHTML='';
  arr.forEach((p,i)=>{
    if(!p.TELEFONO || p.TELEFONO==0) return;          // ignora vacÃ­os
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${p.CODIGO}</td>
      <td>${p.TELEFONO}</td>
      <td><input type="checkbox" value="${p.TELEFONO}"></td>`;
    tbody.appendChild(tr);
  });
}
cargarPaquetes();

/* â”€â”€ 2. enviar seleccionados â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('btnEnviar').addEventListener('click',async()=>{
  const sel=[...document.querySelectorAll('tbody input:checked')];
  if(!sel.length) return alert('Selecciona al menos un telÃ©fono');
  const mensaje=prompt('Mensaje a enviar:');
  if(!mensaje) return;

  for(const chk of sel){
    const tr=chk.closest('tr');
    tr.className='wait';
    const num=chk.value.startsWith('+')?chk.value:`+591${chk.value}`;

    try{
      const r=await fetch('/enviar',{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:new URLSearchParams({ numero:num, mensaje })
      });
      tr.className = r.ok ? 'ok':'fail';
      if(!r.ok){
        console.error('Error',r.status,num);
      }
    }catch(e){
      tr.className='fail';
      console.error('Fetch error',e);
    }
  }
});
</script>
</body>
</html>
